From be31c1259259aec4e15e97727297e70849e8c793 Mon Sep 17 00:00:00 2001
From: Dicky Chiang <dickychiang73@gmail.com>
Date: Sat, 22 Oct 2011 22:50:14 +0800
Subject: [PATCH 10/10] configure nlcp r4 to make for panther board

Add vendorsetup.sh, for use 'mm' to depend on.
---
 Makefile                                           |   14 ++++-
 device/ti/beagleboard/vendorsetup.sh               |   23 ++++++++
 .../wpa_supplicant_6/wpa_supplicant/Android.mk     |    2 +-
 hardware/ti/wlan/mac80211/compat/Makefile          |   57 ++++++++++++++++++++
 4 files changed, 93 insertions(+), 3 deletions(-)
 mode change 100644 => 100755 build/envsetup.sh
 create mode 100755 device/ti/beagleboard/vendorsetup.sh

diff --git a/Makefile b/Makefile
index 06ff54c..ab42ccf 100755
--- a/Makefile
+++ b/Makefile
@@ -15,6 +15,10 @@ ifeq ($(TARGET_PRODUCT), ti816xevm)
 export SYSLINK_VARIANT_NAME := TI816X
 rowboat: sgx kernel_modules
 else
+ifeq ($(TARGET_PRODUCT), beagleboard)
+export BOARD_WLAN_DEVICE := wl12xx_mac80211
+rowboat: sgx wl12xx_mac80211
+else
 ifeq ($(TARGET_PRODUCT), omap3evm)
 rowboat: sgx wl12xx_compat
 else
@@ -30,7 +34,7 @@ endif
 endif
 endif
 endif
-
+endif
 
 ### DO NOT EDIT THIS FILE ###
 include build/core/main.mk
@@ -76,6 +80,9 @@ sgx: build_kernel
 wl12xx_compat: build_kernel
 	$(MAKE) -C hardware/ti/wlan/WL1271_compat/drivers ANDROID_ROOT_DIR=$(ANDROID_INSTALL_DIR) TOOLS_PREFIX=$($(combo_target)TOOLS_PREFIX) ARCH=arm install
 
+wl12xx_mac80211: build_kernel
+	$(MAKE) -C hardware/ti/wlan/mac80211/compat/ ANDROID_ROOT_DIR=$(ANDROID_INSTALL_DIR)                                     TOOLS_PREFIX=$($(combo_target)TOOLS_PREFIX) ARCH=arm install
+
 
 # Build Syslink
 syslink: 
@@ -115,6 +122,9 @@ sgx_clean:
 wl12xx_compat_clean:
 	$(MAKE) -C hardware/ti/wlan/WL1271_compat/drivers ANDROID_ROOT_DIR=$(ANDROID_INSTALL_DIR) TOOLS_PREFIX=$($(combo_target)TOOLS_PREFIX) ARCH=arm clean
 
+wl12xx_mac80211_clean:
+	$(MAKE) -C hardware/ti/wlan/mac80211/compat/ ANDROID_ROOT_DIR=$(ANDROID_INSTALL_DIR)                                     TOOLS_PREFIX=$($(combo_target)TOOLS_PREFIX) ARCH=arm clean
+
 # Clean Syslink
 syslink_clean:
 	@echo "syslink clean"
@@ -128,4 +138,4 @@ fs_clean:
 	rm -rf $(ANDROID_FS_DIR)
 	rm -f $(ANDROID_INSTALL_DIR)/out/target/product/$(TARGET_PRODUCT)/rootfs.tar.bz2
 
-rowboat_clean: clean wl12xx_compat_clean sgx_clean kernel_clean fs_clean syslink_clean
+rowboat_clean: clean wl12xx_compat_clean wl12xx_mac80211_clean sgx_clean kernel_clean fs_clean syslink_clean
diff --git a/build/envsetup.sh b/build/envsetup.sh
old mode 100644
new mode 100755
diff --git a/device/ti/beagleboard/vendorsetup.sh b/device/ti/beagleboard/vendorsetup.sh
new file mode 100755
index 0000000..e25c930
--- /dev/null
+++ b/device/ti/beagleboard/vendorsetup.sh
@@ -0,0 +1,23 @@
+#
+# Copyright (C) 2008 The Android Open Source Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+# This file is executed by build/envsetup.sh, and can use anything
+# defined in envsetup.sh.
+#
+# In particular, you can add lunch options with the add_lunch_combo
+# function: add_lunch_combo generic-eng
+
+add_lunch_combo beagleboard-eng
diff --git a/external/wpa_supplicant_6/wpa_supplicant/Android.mk b/external/wpa_supplicant_6/wpa_supplicant/Android.mk
index d3ab3dd..cd6b5f2 100644
--- a/external/wpa_supplicant_6/wpa_supplicant/Android.mk
+++ b/external/wpa_supplicant_6/wpa_supplicant/Android.mk
@@ -1127,7 +1127,7 @@ endif
 ifneq ($(BOARD_WPA_SUPPLICANT_PRIVATE_LIB),)
 LOCAL_STATIC_LIBRARIES += $(BOARD_WPA_SUPPLICANT_PRIVATE_LIB)
 endif
-LOCAL_SHARED_LIBRARIES := libc libcutils libcrypto libssl
+LOCAL_SHARED_LIBRARIES := libc libcutils libcrypto libssl libnl
 LOCAL_CFLAGS := $(L_CFLAGS)
 LOCAL_SRC_FILES := $(OBJS)
 LOCAL_C_INCLUDES := $(INCLUDES)
diff --git a/hardware/ti/wlan/mac80211/compat/Makefile b/hardware/ti/wlan/mac80211/compat/Makefile
index aa75e81..7bbd1b9 100644
--- a/hardware/ti/wlan/mac80211/compat/Makefile
+++ b/hardware/ti/wlan/mac80211/compat/Makefile
@@ -1,3 +1,11 @@
+###### Build setting for panther board ######
+ifeq ($(TARGET_PRODUCT),beagleboard)
+KLIB ?= $(ANDROID_ROOT_DIR)/kernel
+KLIB_BUILD := $(KLIB)
+DESTDIR?=$(ANDROID_ROOT_DIR)/out/target/product/$(TARGET_PRODUCT)
+endif
+############################################
+
 export KMODDIR?=       updates
 KMODDIR_ARG:=   "INSTALL_MOD_DIR=$(KMODDIR)"
 ifneq ($(origin KLIB), undefined)
@@ -61,6 +69,54 @@ include $(PWD)/$(COMPAT_CONFIG)
 
 all: modules
 
+###### Build setting for panther board ######
+ifeq ($(TARGET_PRODUCT),beagleboard)
+modules:
+	$(MAKE) -C $(KLIB_BUILD) M=$(PWD) -j1 modules
+	@touch $@
+install:
+	$(MAKE) -C $(KLIB_BUILD) M=$(PWD) -j1 modules
+	@echo "Build nlcp r4 for Panther board"
+	@# Creating Target rootfs directories..
+	@echo "Creating Target rootfs directories.."
+	@mkdir -p $(DESTDIR)/system/lib/modules/
+	@mkdir -p $(DESTDIR)/system/etc/firmware/ti-connectivity/
+	@mkdir -p $(DESTDIR)/system/etc/wifi/
+	@mkdir -p $(DESTDIR)/root/data/misc/wifi/
+	@# Installing WLAN modules and scripts to rootfs..
+	@echo "Installing WLAN modules and scripts to rootfs.."
+	@install compat/compat.ko                               $(DESTDIR)/system/lib/modules/
+	@install drivers/net/wireless/wl12xx/wl12xx.ko          $(DESTDIR)/system/lib/modules/
+	@install net/mac80211/mac80211.ko                       $(DESTDIR)/system/lib/modules/
+	@install net/wireless/cfg80211.ko                       $(DESTDIR)/system/lib/modules/
+	@install drivers/net/wireless/wl12xx/wl12xx_sdio.ko     $(DESTDIR)/system/lib/modules/
+	@install drivers/net/wireless/wl12xx/wl12xx_spi.ko      $(DESTDIR)/system/lib/modules/
+	@install ../config/wpa_supplicant.conf                  $(DESTDIR)/system/etc/wifi
+	@install ../config/wpa_supplicant.conf                  $(DESTDIR)/root/data/misc/wifi
+	@# Installing WLAN/BT firmwares and tools to rootfs..
+	@echo "Installing WLAN/BT firmwares and tools to rootfs.."
+	@install ../firmware-files/TIInit_7.2.31.bts $(DESTDIR)/system/etc/firmware/
+	@install ../firmware-files/wl1271-fw-multirole-roc.bin $(DESTDIR)/system/etc/firmware/ti-connectivity/wl1271-fw-multirole-roc.bin
+	@install ../firmware-files/wl1271-fw-multirole-plt.bin $(DESTDIR)/system/etc/firmware/ti-connectivity/wl1271-fw-multirole-plt.bin
+	@install ../firmware-files/wl1271-nvs.bin $(DESTDIR)/system/etc/firmware/ti-connectivity/wl1271-nvs.bin
+
+clean:
+	$(MAKE) -C $(KLIB_BUILD) M=$(PWD) clean
+	@rm -f $(CREL_PRE)*
+	@find . -iname "*.mod.c" -exec rm -rf {} \;
+	@find . -iname "*.o" -exec rm -rf {} \;
+	@find . -iname "*.o.cmd" -exec rm -rf {} \;
+	@find . -iname "*.ko" -exec rm -rf {} \;
+	@find . -iname "*.ko.cmd" -exec rm -rf {} \;
+	@find . -iname "modules.order" -exec rm -rf {} \;
+	@find . -iname "modules" -exec rm -rf {} \;
+	@find . -iname "Module.symvers" -exec rm -rf {} \;
+	@find . -iname "*.tmp_versions" | xargs rm -rf
+
+.PHONY: all clean install
+
+else
+
 modules: $(CREL_CHECK)
 	@./scripts/check_config.sh
 	$(MAKE) -C $(KLIB_BUILD) M=$(PWD) modules
@@ -458,6 +514,7 @@ wlunload:
 .PHONY: all clean install uninstall unload btunload wlunload modules bt
 
 endif
+endif ### Build setting for panthen board
 
 clean-files += Module.symvers Module.markers modules modules.order
 clean-files += $(CREL_CHECK) $(CONFIG_CHECK)
-- 
1.7.4.1

